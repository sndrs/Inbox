<!DOCTYPE html>
<html>

    <head>
    <title>Inbox</title>
        <style>
        body {
            background-color: #4285f4;
        }

        #mail-view {
            position: absolute;
            top: 22px;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 200ms;
        }

        #status-view {
            visibility: hidden;
            position: absolute;
            bottom: 0;
        }
        </style>
    </head>

    <body>
        <webview src="https://mail.google.com/mail/feed/atom" id="status-view" nodeintegration></webview>
        <webview src="https://inbox.google.com" allowpopups plugins autosize="on" id="mail-view" nodeintegration></webview>
        <script>
            const mailView = document.getElementById('mail-view');
            const ipc = require('ipc');

            // show webview once there's a response of some kind
            mailView.addEventListener('did-get-response-details', showMailView);

            function showMailView() {
                mailView.style.opacity = 1;
                mailView.removeEventListener('did-get-response-details', showMailView);
            };

            mailView.addEventListener('dom-ready', () => {
                // listen for new mail
                mailView.executeJavaScript(require('./change-observer'));
            });

            // handle links in emails
            mailView.addEventListener('new-window', (e) => {
                require('shell').openExternal(e.url);
            });

            // show notification when new mail arrives
            ipc.on('NOTIFY', data => {
                Notification.requestPermission();
                new Notification(data.title, data);
            });

            const statusView = document.getElementById('status-view');
            statusView.addEventListener('dom-ready', () => {
                statusView.executeJavaScript(require('./get-mail-status'));
            });

            ipc.on('INBOX_CHANGE', (e) => {
                // console.log('pingping', Date.now());
                statusView.reloadIgnoringCache();
            });

            // create menubar app menu
            require('./menu');
        </script>
    </body>

</html>
